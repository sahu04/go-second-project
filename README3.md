# Jenkins Pipeline with Trivy and Dockle Container Image Scanning and Report

This Jenkins pipeline is designed to automate the scanning of container images for security vulnerabilities and best practices compliance. It utilizes Trivy for comprehensive vulnerability scanning and Dockle for Dockerfile best practices and image scanning.

Pre-requistis:
 - Jenkins server is installed and configured.
 - Docker is installed on the Jenkins server.
 - Docker Daemon is accessible to Jenkins (if running in a separate environment).      


## Setup

1. Ensure Jenkins is properly configured and has access to your version control system (e.g., Git).

2. Jenkins Plugins: Make sure the necessary Jenkins plugins are installed:
  - Pipeline
  - HTML Publisher Plugin

3. Create Jenkins Pipeline:
 - In this template we will be using Declarative pipeline.

## Agent
The agent section specifies where the entire Pipeline, or a specific stage, will execute in the Jenkins environment depending on where the agent section is placed. The section must be defined at the top-level inside the pipeline block
#### Execute the Pipeline, or stage, on any available agent. For example: agent any.

```
pipeline
{
  agent any
}
```

## Stages
Containing a sequence of one or more stage directives, the stages section is where the bulk of the "work" described by a Pipeline will be located.
At a minimum, it is recommended that stages contain at least one stage directive for each discrete part of the continuous delivery process, such as Build, Test, and Deploy.
```
stages {
    stage('SCM-Checkout') {
        steps {
             '' // Git checkout step here
        }
    }
}

```

## Environment
#### The environment directive specifies a sequence of key-value pairs which will be defined as environment variables for all steps, or stage-specific steps, depending on where the environment directive is located within the Pipeline.

```
pipeline {
    agent any
    environment {
        DOCKERFILE_PATH = "./Dockerfile"
        TRIVY_REPORT_PATH = "trivy-scan-report.json"
        DOCKLE_REPORT_PATH = "dockle-scan-report.json"
    }
}
```
## Pipeline stages:
### Build_Image:
#### These stage in the Jenkins pipeline, dynamically retrieves the name of a Docker image from a specified Dockerfile. It then uses this name to build the Docker image and tags it accordingly. Finally, the script prints out the name of the built Docker image for reference, streamlining the process of Docker image creation within the Jenkins pipeline:
```
 dockerImageName = (script: "awk 'NR==1 {print \$2}' ${DOCKERFILE_PATH}", returnStdout: true).trim()
 docker build -t ${dockerImageName} -f ${DOCKERFILE_PATH} .
 echo "Docker image name: ${dockerImageName}"
``` 

### Install Trivy and Dockle:
#### These stage in the Jenkins pipeline Install Trivy ensures the installation of Trivy, a container image vulnerability scanner. It sets appropriate permissions and verifies the installation with the trivy --version command and the installation of Dockle, a Dockerfile linter. It downloads the Dockle binary, extracts it, moves it to the appropriate directory, and verifies the installation with the dockle --version command:
```
sudo chmod o+w /usr/local/bin
curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v0.48.3
wget https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/html.tpl
trivy --version

curl -LO https://github.com/goodwithtech/dockle/releases/download/v0.4.13/dockle_0.4.13_Linux-64bit.tar.gz
tar -xzf dockle_0.4.13_Linux-64bit.tar.gz
sudo mv dockle /usr/local/bin/
dockle --version
```

### Scan image for vulnerabilities-Trivy:
#### In this Jenkins stage, Trivy checks a Docker image for security issues. It finds the image's name, runs the scan, and creates reports in different formats, like tables and HTML, to help understand any problems with the image's security.:
```
trivy image --scanners vuln --format table $dockerImageName
trivy image --scanners vuln --format json -o $TRIVY_REPORT_PATH $dockerImageName
trivy image --scanners vuln --format template --template @./html.tpl -o report.html $dockerImageName
```
### Security Scan - Dockle:
#### This stage runs a Dockle security scan on a Docker image, capturing potential issues in JSON format and saving them to a designated path. It ensures adherence to best practices and enhances container image security.
```
dockle -f json -o ${DOCKLE_REPORT_PATH} --exit-code 1 --exit-level fatal ${dockerImageName}
```

### Publish HTML Report and Archive HTML Report:
#### these stages of the Jenkins pipeline, an HTML report generated by Trivy and Dockle scans is archived and published. The "Archive HTML Report" stage archives the HTML report for future reference, while the "Publish HTML Report" stage makes the report accessible in Jenkins. After execution, artifacts from Trivy and Dockle scans are archived, and the workspace is cleaned up to maintain pipeline cleanliness and efficiency:
```
archiveArtifacts artifacts: 'report.html', fingerprint: true
  publishHTML(
    target: [
        reportDir: '.',
        reportFiles: 'report.html',
        reportName: 'Trivy Security Report'
    ]
)
archiveArtifacts artifacts: "${TRIVY_REPORT_PATH},${DOCKLE_REPORT_PATH}", followSymlinks: false
deleteDir() // Clean the workspace
``` 

4. Trigger the Jenkins pipeline manually or set up webhooks for automatic triggering.

5. Review Trivy and Dockle reports.
